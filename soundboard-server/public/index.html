<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>313 Soundboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #EDE0CC;
  --bg-warm: #E4D5BD;
  --cream: #FAF4EA;
  --cream-dark: #F0E6D4;
  --orange: #D4520A;
  --orange-hover: #E86920;
  --orange-dark: #B5430A;
  --brown: #2D1B0E;
  --brown-mid: #6B4C32;
  --brown-light: #9A7B5B;
  --border: #8B7355;
  --red: #C23616;
  --green: #4A7A2E;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: "Space Mono", monospace;
  background: var(--bg);
  color: var(--brown);
  min-height: 100vh;
  position: relative;
}

/* Subtle paper grain overlay */
body::after {
  content: '';
  position: fixed;
  inset: 0;
  opacity: 0.025;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  background-size: 200px 200px;
  pointer-events: none;
  z-index: 10000;
}

/* ============ LOGIN SCREEN ============ */
#login-screen {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  background: var(--bg);
  position: relative;
}
#login-screen::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 6px;
  background: var(--orange);
}
#login-screen::after {
  content: '';
  position: absolute;
  inset: 0;
  background: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 3px,
    rgba(45, 27, 14, 0.015) 3px,
    rgba(45, 27, 14, 0.015) 6px
  );
  pointer-events: none;
}

#login-card {
  border: 3px solid var(--brown);
  background: var(--cream);
  padding: 48px 56px;
  box-shadow: 6px 6px 0 var(--brown);
  text-align: center;
  position: relative;
  z-index: 1;
}
#login-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 6px;
  background: var(--orange);
}

#login-brand {
  font-size: 48px;
  font-weight: 700;
  color: var(--orange);
  letter-spacing: 8px;
  line-height: 1;
  margin-bottom: 4px;
}
#login-sub {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 6px;
  color: var(--brown-mid);
  margin-bottom: 32px;
}
#login-label {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 3px;
  color: var(--brown-light);
  margin-bottom: 8px;
}
#room-input {
  display: block;
  width: 200px;
  margin: 0 auto 20px;
  padding: 14px 16px;
  border: 3px solid var(--brown);
  background: var(--cream-dark);
  color: var(--brown);
  font-family: "Space Mono", monospace;
  font-size: 24px;
  font-weight: 700;
  text-align: center;
  text-transform: uppercase;
  letter-spacing: 6px;
  outline: none;
  box-shadow: inset 2px 2px 0 rgba(45, 27, 14, 0.08);
}
#room-input:focus { border-color: var(--orange); }
#room-input::placeholder {
  color: var(--brown-light);
  letter-spacing: 3px;
  font-size: 14px;
  text-transform: uppercase;
}

.btn {
  font-family: "Space Mono", monospace;
  font-weight: 700;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 2px;
  border: 3px solid var(--brown);
  cursor: pointer;
  box-shadow: 3px 3px 0 var(--brown);
  transition: transform 0.04s, box-shadow 0.04s;
}
.btn:active {
  transform: translate(2px, 2px);
  box-shadow: 1px 1px 0 var(--brown);
}
.btn:disabled { opacity: 0.4; cursor: default; transform: none; box-shadow: 3px 3px 0 var(--brown); }

.btn-primary {
  background: var(--orange);
  color: var(--cream);
  border-color: var(--brown);
}
.btn-primary:hover:not(:disabled) { background: var(--orange-hover); }

#join-btn { padding: 12px 40px; }

#login-error {
  color: var(--red);
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  min-height: 16px;
  margin-top: 16px;
}

/* ============ MAIN APP ============ */
#app { display: none; }

#top-stripe {
  height: 6px;
  background: var(--orange);
}

#top-bar {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 20px;
  background: var(--cream);
  border-bottom: 3px solid var(--brown);
  flex-wrap: wrap;
}

#brand {
  font-size: 24px;
  font-weight: 700;
  color: var(--orange);
  letter-spacing: 4px;
  line-height: 1;
  white-space: nowrap;
}
#brand-sub {
  font-size: 8px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 3px;
  color: var(--brown-mid);
  display: block;
  margin-top: 1px;
}

#room-display {
  font-size: 10px;
  font-weight: 700;
  color: var(--brown-mid);
  background: var(--bg-warm);
  padding: 4px 10px;
  border: 2px solid var(--border);
  letter-spacing: 3px;
  text-transform: uppercase;
}

#add-form {
  display: flex;
  gap: 8px;
  flex: 1;
  min-width: 250px;
  margin-left: auto;
}
#url-input {
  flex: 1;
  padding: 8px 12px;
  border: 3px solid var(--brown);
  background: var(--cream-dark);
  color: var(--brown);
  font-family: "Space Mono", monospace;
  font-size: 11px;
  outline: none;
  box-shadow: inset 2px 2px 0 rgba(45, 27, 14, 0.06);
}
#url-input:focus { border-color: var(--orange); }
#url-input::placeholder { color: var(--brown-light); font-size: 11px; }

#add-btn { padding: 8px 16px; font-size: 11px; }

/* ============ CONTROLS BAR ============ */
#controls {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 20px;
  background: var(--bg-warm);
  border-bottom: 2px solid var(--border);
}
#controls label {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--brown-mid);
}
#vol-slider {
  -webkit-appearance: none;
  width: 100px;
  height: 6px;
  background: var(--border);
  outline: none;
}
#vol-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px; height: 18px;
  background: var(--orange);
  border: 2px solid var(--brown);
  cursor: pointer;
}
#vol-slider::-moz-range-thumb {
  width: 18px; height: 18px;
  background: var(--orange);
  border: 2px solid var(--brown);
  cursor: pointer;
  border-radius: 0;
}

#username-input {
  padding: 5px 10px;
  border: 2px solid var(--border);
  background: var(--cream);
  color: var(--brown);
  font-family: "Space Mono", monospace;
  font-size: 11px;
  width: 130px;
  outline: none;
  margin-left: auto;
}
#username-input:focus { border-color: var(--orange); }
#username-input::placeholder { color: var(--brown-light); }

#status {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.connected { color: var(--green); }
.disconnected { color: var(--red); }

/* ============ SECTIONS ============ */
.section-label {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 4px;
  color: var(--orange);
  padding: 16px 20px 8px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.section-label::after {
  content: '';
  flex: 1;
  height: 2px;
  background: var(--orange);
  opacity: 0.3;
}

/* ============ POPULAR ROW ============ */
#popular-section { display: none; }
#popular-row {
  display: flex;
  gap: 10px;
  padding: 0 20px 12px;
  overflow-x: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--border) transparent;
}
#popular-row::-webkit-scrollbar { height: 4px; }
#popular-row::-webkit-scrollbar-thumb { background: var(--border); }

.popular-btn {
  flex-shrink: 0;
  min-width: 150px;
  max-width: 200px;
  padding: 12px 14px;
  border: 3px solid var(--orange-dark);
  background: var(--cream);
  color: var(--brown);
  font-family: "Space Mono", monospace;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  text-align: left;
  cursor: pointer;
  box-shadow: 3px 3px 0 var(--orange-dark);
  transition: transform 0.04s, box-shadow 0.04s;
  position: relative;
  word-break: break-word;
  line-height: 1.3;
}
.popular-btn:hover {
  background: var(--orange);
  color: var(--cream);
}
.popular-btn:active {
  transform: translate(2px, 2px);
  box-shadow: 1px 1px 0 var(--orange-dark);
}
.popular-btn.playing {
  background: var(--orange) !important;
  color: var(--cream) !important;
  animation: pressDown 0.2s ease;
}
.popular-btn .play-count {
  display: inline-block;
  font-size: 9px;
  color: var(--cream);
  background: var(--orange);
  padding: 1px 6px;
  margin-top: 6px;
  letter-spacing: 1px;
}
.popular-btn:hover .play-count {
  background: var(--orange-dark);
}
.popular-btn .who {
  display: block;
  font-size: 9px;
  font-weight: 400;
  color: var(--orange);
  text-transform: none;
  letter-spacing: 0;
  margin-top: 4px;
  min-height: 13px;
}

/* ============ SOUND GRID ============ */
#sounds {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(145px, 1fr));
  gap: 10px;
  padding: 8px 20px 20px;
}

.sound-btn {
  position: relative;
  padding: 14px 10px 10px;
  border: 3px solid var(--brown);
  background: var(--cream);
  color: var(--brown);
  font-family: "Space Mono", monospace;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  cursor: pointer;
  text-align: center;
  word-break: break-word;
  line-height: 1.3;
  box-shadow: 3px 3px 0 var(--brown);
  transition: transform 0.04s, box-shadow 0.04s, border-color 0.1s;
}
.sound-btn:hover {
  border-color: var(--orange);
  box-shadow: 3px 3px 0 var(--orange);
}
.sound-btn:active {
  transform: translate(2px, 2px);
  box-shadow: 1px 1px 0 var(--brown);
}
.sound-btn.playing {
  background: var(--orange) !important;
  color: var(--cream) !important;
  border-color: var(--orange-dark) !important;
  box-shadow: 3px 3px 0 var(--orange-dark) !important;
  animation: pressDown 0.2s ease;
}

@keyframes pressDown {
  0% { transform: translate(0, 0); }
  40% { transform: translate(2px, 2px); box-shadow: 1px 1px 0 var(--brown); }
  100% { transform: translate(0, 0); }
}

/* Color accent stripe on top of button */
.sound-btn.has-color::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 5px;
  background: var(--sound-color);
}

.sound-btn .sound-title { display: block; }
.sound-btn .who {
  display: block;
  font-size: 9px;
  font-weight: 400;
  color: var(--orange);
  text-transform: none;
  letter-spacing: 0;
  margin-top: 4px;
  min-height: 13px;
}

.sound-btn .delete-btn {
  position: absolute;
  top: 3px; right: 5px;
  background: none;
  border: none;
  color: var(--brown-light);
  cursor: pointer;
  font-size: 15px;
  font-weight: 700;
  line-height: 1;
  padding: 2px;
  font-family: "Space Mono", monospace;
  opacity: 0;
  transition: opacity 0.1s;
}
.sound-btn:hover .delete-btn { opacity: 1; }
.sound-btn .delete-btn:hover { color: var(--red); }

.sound-btn .palette-btn {
  position: absolute;
  bottom: 4px; left: 5px;
  width: 14px; height: 14px;
  border: 2px solid var(--brown-light);
  background: transparent;
  cursor: pointer;
  padding: 0;
  opacity: 0;
  transition: opacity 0.12s, border-color 0.1s;
}
.sound-btn:hover .palette-btn { opacity: 0.6; }
.sound-btn .palette-btn:hover { opacity: 1 !important; border-color: var(--orange); }
.sound-btn .palette-btn.has-color {
  opacity: 1;
  border-color: var(--brown);
}

/* ============ COLOR PICKER POPUP ============ */
.color-picker-popup {
  position: fixed;
  display: flex;
  gap: 5px;
  flex-wrap: wrap;
  width: 155px;
  padding: 8px;
  background: var(--cream);
  border: 3px solid var(--brown);
  box-shadow: 4px 4px 0 var(--brown);
  z-index: 5000;
}
.color-opt {
  width: 24px; height: 24px;
  border: 2px solid var(--brown);
  cursor: pointer;
  padding: 0;
  transition: transform 0.08s;
}
.color-opt:hover { transform: scale(1.2); }
.color-none {
  background: var(--bg);
  color: var(--brown-mid);
  font-size: 14px;
  font-weight: 700;
  font-family: "Space Mono", monospace;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ============ TOAST ============ */
#toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--brown);
  color: var(--cream);
  padding: 10px 24px;
  border: 3px solid var(--brown);
  font-family: "Space Mono", monospace;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  display: none;
  z-index: 9999;
  box-shadow: 3px 3px 0 var(--orange);
}
#toast.error {
  background: var(--red);
  border-color: var(--red);
  box-shadow: 3px 3px 0 #8B1A0E;
}

#empty {
  text-align: center;
  color: var(--brown-light);
  padding: 60px 20px;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 2px;
  grid-column: 1 / -1;
}

@media (max-width: 600px) {
  #top-bar { padding: 12px 14px; gap: 8px; }
  #brand { font-size: 20px; letter-spacing: 3px; }
  #add-form { min-width: 0; }
  #sounds { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; padding: 8px 14px 14px; }
  #login-card { padding: 32px 28px; }
  #login-brand { font-size: 36px; }
}
</style>
</head>
<body>

<!-- ===== LOGIN SCREEN ===== -->
<div id="login-screen">
  <div id="login-card">
    <div id="login-brand">313</div>
    <div id="login-sub">Soundboard</div>
    <div id="login-label">Access Code</div>
    <input id="room-input" type="text" maxlength="10" placeholder="CODE" autocomplete="off" spellcheck="false">
    <button id="join-btn" class="btn btn-primary">Enter</button>
    <div id="login-error"></div>
  </div>
</div>

<!-- ===== MAIN APP ===== -->
<div id="app">
  <div id="top-stripe"></div>
  <div id="top-bar">
    <div>
      <div id="brand">313</div>
      <span id="brand-sub">Soundboard</span>
    </div>
    <div id="room-display"></div>
    <div id="add-form">
      <input id="url-input" type="text" placeholder="Paste MyInstants link...">
      <button id="add-btn" class="btn btn-primary">Add</button>
    </div>
  </div>

  <div id="controls">
    <label>Vol</label>
    <input id="vol-slider" type="range" min="0" max="100" value="80">
    <span id="status" class="disconnected">Connecting...</span>
    <input id="username-input" type="text" placeholder="Your name">
  </div>

  <div id="popular-section">
    <div class="section-label">Most Played</div>
    <div id="popular-row"></div>
  </div>

  <div id="all-label" class="section-label" style="display:none">All Sounds</div>
  <div id="sounds">
    <div id="empty">No sounds yet. Paste a MyInstants link above.</div>
  </div>
</div>

<div id="toast"></div>

<script>
(function() {
  var roomCode = localStorage.getItem("sb_room") || "";
  var sounds = [];
  var volume = 0.8;
  var ws = null;
  var reconnectTimer = null;
  var username = localStorage.getItem("sb_username") || "";
  var audioCtx = null;
  var audioBuffers = {};
  var playDebounce = {};
  var colorPicker = null;

  var COLORS = [
    { name: "Flame",   hex: "#D4520A" },
    { name: "Crimson", hex: "#C23616" },
    { name: "Mustard", hex: "#C9A812" },
    { name: "Forest",  hex: "#4A7A2E" },
    { name: "Ocean",   hex: "#2E6B8A" },
    { name: "Grape",   hex: "#7B3FA0" },
    { name: "Rose",    hex: "#C75B8E" },
    { name: "Slate",   hex: "#5B6B7A" }
  ];

  var loginScreen = document.getElementById("login-screen");
  var appEl = document.getElementById("app");
  var roomInput = document.getElementById("room-input");
  var joinBtn = document.getElementById("join-btn");
  var loginError = document.getElementById("login-error");
  var roomDisplay = document.getElementById("room-display");
  var popularSection = document.getElementById("popular-section");
  var popularRow = document.getElementById("popular-row");
  var allLabel = document.getElementById("all-label");
  var soundsEl = document.getElementById("sounds");
  var statusEl = document.getElementById("status");
  var urlInput = document.getElementById("url-input");
  var addBtn = document.getElementById("add-btn");
  var volSlider = document.getElementById("vol-slider");
  var usernameInput = document.getElementById("username-input");
  var toastEl = document.getElementById("toast");

  var toastTimer;
  function toast(msg, isError) {
    toastEl.textContent = msg;
    toastEl.className = isError ? "error" : "";
    toastEl.style.display = "block";
    clearTimeout(toastTimer);
    toastTimer = setTimeout(function() { toastEl.style.display = "none"; }, 3000);
  }

  function getAudioCtx() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume();
    return audioCtx;
  }

  function preloadSound(sound) {
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "/sounds/" + sound.filename, true);
    xhr.responseType = "arraybuffer";
    xhr.onload = function() {
      if (xhr.status === 200) {
        getAudioCtx().decodeAudioData(xhr.response, function(buffer) {
          audioBuffers[sound.id] = buffer;
        }, function() {});
      }
    };
    xhr.send();
  }

  function preloadAllSounds() {
    sounds.forEach(function(s) { if (!audioBuffers[s.id]) preloadSound(s); });
  }

  function tryLogin(code) {
    code = code.trim().toUpperCase();
    if (!code.length) return;
    joinBtn.disabled = true;
    joinBtn.textContent = "...";
    loginError.textContent = "";

    fetch("/api/sounds?room=" + encodeURIComponent(code))
      .then(function(r) {
        if (r.status === 403) throw new Error("INVALID CODE");
        return r.json();
      })
      .then(function(data) {
        roomCode = code;
        localStorage.setItem("sb_room", roomCode);
        sounds = data;
        showApp();
      })
      .catch(function(err) {
        loginError.textContent = err.message || "CONNECTION FAILED";
      })
      .finally(function() {
        joinBtn.disabled = false;
        joinBtn.textContent = "ENTER";
      });
  }

  function showApp() {
    loginScreen.style.display = "none";
    appEl.style.display = "block";
    roomDisplay.textContent = "ROOM " + roomCode;
    usernameInput.value = username;
    render();
    preloadAllSounds();
    connect();
  }

  function showLogin() {
    loginScreen.style.display = "";
    appEl.style.display = "none";
    roomInput.value = roomCode;
    roomInput.focus();
  }

  joinBtn.addEventListener("click", function() { tryLogin(roomInput.value); });
  roomInput.addEventListener("keydown", function(e) { if (e.key === "Enter") tryLogin(roomInput.value); });

  if (roomCode) { tryLogin(roomCode); } else { showLogin(); }

  function connect() {
    if (ws) { try { ws.close(); } catch {} }
    var proto = location.protocol === "https:" ? "wss:" : "ws:";
    ws = new WebSocket(proto + "//" + location.host + "?room=" + encodeURIComponent(roomCode));

    ws.onopen = function() {
      statusEl.textContent = "ONLINE";
      statusEl.className = "connected";
      clearTimeout(reconnectTimer);
    };
    ws.onclose = function() {
      statusEl.textContent = "OFFLINE";
      statusEl.className = "disconnected";
      reconnectTimer = setTimeout(connect, 2000);
    };
    ws.onmessage = function(e) {
      var msg = JSON.parse(e.data);
      if (msg.type === "init") {
        sounds = msg.sounds;
        render();
        preloadAllSounds();
      } else if (msg.type === "sound_added") {
        sounds.push(msg.sound);
        render();
        preloadSound(msg.sound);
        toast("ADDED: " + msg.sound.title);
      } else if (msg.type === "sound_removed") {
        sounds = sounds.filter(function(s) { return s.id !== msg.id; });
        delete audioBuffers[msg.id];
        render();
      } else if (msg.type === "sound_updated") {
        var su = sounds.find(function(s) { return s.id === msg.id; });
        if (su) {
          if (msg.color !== undefined) su.color = msg.color;
          render();
        }
      } else if (msg.type === "play") {
        var sp = sounds.find(function(s) { return s.id === msg.id; });
        if (sp && msg.plays !== undefined) sp.plays = msg.plays;
        playLocally(msg.id, msg.user);
        updatePlayCountBadges(msg.id, msg.plays);
      } else if (msg.type === "error") {
        toast(msg.error, true);
      }
    };
  }

  function render() {
    closeColorPicker();

    var popular = sounds.filter(function(s) { return (s.plays || 0) > 0; })
      .sort(function(a, b) { return (b.plays || 0) - (a.plays || 0); })
      .slice(0, 5);

    if (popular.length > 0) {
      popularSection.style.display = "";
      while (popularRow.firstChild) popularRow.removeChild(popularRow.firstChild);
      popular.forEach(function(sound) {
        popularRow.appendChild(createPopularButton(sound));
      });
    } else {
      popularSection.style.display = "none";
    }

    allLabel.style.display = (popular.length > 0 && sounds.length > 0) ? "" : "none";
    while (soundsEl.firstChild) soundsEl.removeChild(soundsEl.firstChild);

    if (sounds.length === 0) {
      var empty = document.createElement("div");
      empty.id = "empty";
      empty.textContent = "No sounds yet \u2014 paste a MyInstants link above.";
      soundsEl.appendChild(empty);
      return;
    }

    sounds.forEach(function(sound) {
      soundsEl.appendChild(createSoundButton(sound));
    });
  }

  function createPopularButton(sound) {
    var btn = document.createElement("button");
    btn.className = "popular-btn";
    btn.dataset.id = sound.id;

    if (sound.color) {
      btn.style.borderTopWidth = "5px";
      btn.style.borderTopColor = sound.color;
    }

    var title = document.createElement("span");
    title.textContent = sound.title;
    btn.appendChild(title);

    var count = document.createElement("span");
    count.className = "play-count";
    count.textContent = (sound.plays || 0) + "x";
    btn.appendChild(count);

    var who = document.createElement("span");
    who.className = "who";
    btn.appendChild(who);

    btn.addEventListener("click", function() {
      var now = Date.now();
      if (playDebounce[sound.id] && now - playDebounce[sound.id] < 200) return;
      playDebounce[sound.id] = now;
      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: "play", id: sound.id, user: getUsername() }));
      }
    });

    return btn;
  }

  function createSoundButton(sound) {
    var btn = document.createElement("button");
    btn.className = "sound-btn";
    btn.dataset.id = sound.id;

    if (sound.color) {
      btn.classList.add("has-color");
      btn.style.setProperty("--sound-color", sound.color);
    }

    var title = document.createElement("span");
    title.className = "sound-title";
    title.textContent = sound.title;
    btn.appendChild(title);

    var who = document.createElement("span");
    who.className = "who";
    btn.appendChild(who);

    var del = document.createElement("button");
    del.className = "delete-btn";
    del.textContent = "\u00d7";
    del.title = "Remove";
    del.addEventListener("click", function(e) {
      e.stopPropagation();
      deleteSound(sound.id);
    });
    btn.appendChild(del);

    var palette = document.createElement("button");
    palette.className = "palette-btn" + (sound.color ? " has-color" : "");
    if (sound.color) palette.style.background = sound.color;
    palette.title = "Set color";
    palette.addEventListener("click", function(e) {
      e.stopPropagation();
      var rect = palette.getBoundingClientRect();
      showColorPicker(sound.id, rect.left, rect.bottom + 5);
    });
    btn.appendChild(palette);

    btn.addEventListener("click", function() {
      var now = Date.now();
      if (playDebounce[sound.id] && now - playDebounce[sound.id] < 200) return;
      playDebounce[sound.id] = now;
      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: "play", id: sound.id, user: getUsername() }));
      }
    });

    return btn;
  }

  function showColorPicker(soundId, x, y) {
    closeColorPicker();
    var popup = document.createElement("div");
    popup.className = "color-picker-popup";

    if (x + 160 > window.innerWidth) x = window.innerWidth - 170;
    if (y + 70 > window.innerHeight) y = y - 90;
    if (x < 5) x = 5;
    popup.style.left = x + "px";
    popup.style.top = y + "px";

    var none = document.createElement("button");
    none.className = "color-opt color-none";
    none.title = "Clear";
    none.textContent = "\u00d7";
    none.addEventListener("click", function(e) {
      e.stopPropagation();
      setColor(soundId, null);
      closeColorPicker();
    });
    popup.appendChild(none);

    COLORS.forEach(function(c) {
      var opt = document.createElement("button");
      opt.className = "color-opt";
      opt.style.background = c.hex;
      opt.title = c.name;
      opt.addEventListener("click", function(e) {
        e.stopPropagation();
        setColor(soundId, c.hex);
        closeColorPicker();
      });
      popup.appendChild(opt);
    });

    document.body.appendChild(popup);
    colorPicker = popup;
    setTimeout(function() { document.addEventListener("click", closeColorPicker); }, 0);
  }

  function closeColorPicker() {
    if (colorPicker) {
      if (colorPicker.parentNode) colorPicker.parentNode.removeChild(colorPicker);
      colorPicker = null;
      document.removeEventListener("click", closeColorPicker);
    }
  }

  function setColor(id, color) {
    fetch("/api/sounds/" + id + "/color?room=" + encodeURIComponent(roomCode), {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ color: color })
    }).catch(function() { toast("Failed to set color", true); });
  }

  function playLocally(id, user) {
    var sound = sounds.find(function(s) { return s.id === id; });
    if (!sound) return;
    var ctx = getAudioCtx();
    var buffer = audioBuffers[id];
    if (buffer) {
      var source = ctx.createBufferSource();
      var gain = ctx.createGain();
      gain.gain.value = volume;
      source.buffer = buffer;
      source.connect(gain);
      gain.connect(ctx.destination);
      source.start(0);
      showPlayFeedback(id, user, buffer.duration);
    } else {
      var audio = new Audio("/sounds/" + sound.filename);
      audio.volume = volume;
      audio.play().catch(function() {});
      showPlayFeedback(id, user, 2);
      preloadSound(sound);
    }
  }

  function showPlayFeedback(id, user, duration) {
    var allBtns = document.querySelectorAll('[data-id="' + id + '"]');
    allBtns.forEach(function(btn) {
      btn.classList.add("playing");
      var who = btn.querySelector(".who");
      if (who) who.textContent = user || "";
      setTimeout(function() { btn.classList.remove("playing"); }, 250);
      var clearTime = Math.min((duration || 2) * 1000, 10000);
      setTimeout(function() { if (who) who.textContent = ""; }, clearTime);
    });
  }

  function updatePlayCountBadges(id, plays) {
    var badges = document.querySelectorAll('[data-id="' + id + '"] .play-count');
    badges.forEach(function(b) { b.textContent = (plays || 0) + "x"; });
  }

  function addSound() {
    var url = urlInput.value.trim();
    if (!url) return;
    addBtn.disabled = true;
    addBtn.textContent = "...";
    fetch("/api/sounds?room=" + encodeURIComponent(roomCode), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ url: url })
    })
    .then(function(r) {
      return r.json().then(function(data) {
        if (!r.ok) toast(data.error || "Failed to add sound", true);
        return data;
      });
    })
    .then(function() { urlInput.value = ""; })
    .catch(function() { toast("Failed to add sound", true); })
    .finally(function() { addBtn.disabled = false; addBtn.textContent = "ADD"; });
  }

  function deleteSound(id) {
    fetch("/api/sounds/" + id + "?room=" + encodeURIComponent(roomCode), { method: "DELETE" })
      .catch(function() { toast("Failed to delete", true); });
  }

  function getUsername() { return usernameInput.value.trim() || "Someone"; }

  addBtn.addEventListener("click", addSound);
  urlInput.addEventListener("keydown", function(e) { if (e.key === "Enter") addSound(); });
  volSlider.addEventListener("input", function() { volume = parseInt(this.value) / 100; });
  usernameInput.addEventListener("input", function() {
    username = this.value;
    localStorage.setItem("sb_username", this.value);
  });
})();
</script>
</body>
</html>
